<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Remove Corners — Preview & Download</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@300;400;600;700&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    :root {
      /* Default Theme: Pastel Dreams (Pink/Blue) */
      --bg: #FDFBF7;
      --card: #FFFFFF;
      --text: #2D3748;
      --muted: #4A5568;
      --primary: #AEC6CF;
      --primary-hover: #9AB5BF;
      --secondary: #FFB7B2;
      --secondary-hover: #EFA6A1;
      --border: #F0F0F0;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    }

    /* Theme 2: Lavender Garden */
    [data-theme="lavender"] {
      --bg: #F8F6FB;
      --primary: #D4C5E2;
      --primary-hover: #C0B0D0;
      --secondary: #E6B8E8;
      --secondary-hover: #D4A6D6;
      --border: #F0E6F6;
    }

    /* Theme 3: Mint Peach */
    [data-theme="mint"] {
      --bg: #F6FBF9;
      --primary: #B8E6D5;
      --primary-hover: #A4D4C3;
      --secondary: #FFD4B8;
      --secondary-hover: #F5C5A6;
      --border: #E6F6F0;
    }

    /* Smooth theme transitions */
    body {
      transition: background-color 0.3s ease;
    }

    .card,
    .sidebar,
    .btn,
    .nav-item,
    .upload-area,
    .controls {
      transition: all 0.3s ease;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Noto Sans Thai Looped', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.02);
    }

    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-items {
      padding: 16px 0;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: #FAFAFA;
      color: var(--text);
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(174, 198, 207, 0.1) 0%, transparent 100%);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item i {
      font-size: 20px;
    }

    .content {
      flex: 1;
      overflow-y: auto;
    }

    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Theme Selector Styles */
    .theme-selector {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
    }

    .theme-selector-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .theme-options {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .theme-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .theme-option.active {
      border-color: var(--text);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text);
    }

    .theme-option.active::after {
      content: '✓';
      position: absolute;
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Theme color swatches */
    .theme-pastel {
      background: linear-gradient(135deg, #AEC6CF 0%, #FFB7B2 100%);
    }

    .theme-lavender {
      background: linear-gradient(135deg, #D4C5E2 0%, #E6B8E8 100%);
    }

    .theme-mint {
      background: linear-gradient(135deg, #B8E6D5 0%, #FFD4B8 100%);
    }

    .wrap {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 24px;
      padding: 40px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    h1 {
      margin: 0 0 12px;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.5px;
    }

    p.lead {
      margin: 0 0 32px;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.6;
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 32px;
      align-items: center;
      background: #FAFAFA;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    input[type=file] {
      display: block;
      font-size: 14px;
      color: var(--muted);
    }

    input[type=file]::file-selector-button {
      background: #fff;
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      margin-right: 12px;
      transition: all 0.2s;
    }

    input[type=file]::file-selector-button:hover {
      background: #f5f5f5;
    }

    .btn {
      background: var(--primary);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(174, 198, 207, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Noto Sans Thai Looped', sans-serif;
    }

    .btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary {
      background: var(--secondary);
      box-shadow: 0 4px 12px rgba(255, 183, 178, 0.3);
    }

    .btn.secondary:hover {
      background: var(--secondary-hover);
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .thumb {
      background: #fff;
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s;
    }

    .thumb:hover {
      transform: translateY(-2px);
    }

    .thumb img {
      width: 100%;
      height: 140px;
      border-radius: 12px;
      object-fit: contain;
      background: repeating-conic-gradient(#f8f9fb 0% 25%, transparent 0% 50%) 50% / 20px 20px;
    }

    .thumb .meta {
      font-size: 13px;
      color: var(--muted);
      margin-top: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .thumb .actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      width: 100%;
    }

    .thumb .actions .btn {
      width: 100%;
      padding: 8px;
      font-size: 12px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    input[type="number"] {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-family: 'Noto Sans Thai Looped', sans-serif;
      width: 80px;
      font-family: inherit;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus {
      border-color: var(--primary);
    }

    footer {
      margin-top: 40px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      opacity: 0.7;
    }

    .upload-area {
      border: 2px dashed #E0E0E0;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #FAFAFA;
      margin-bottom: 32px;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: #F0F7FA;
    }

    .upload-area.dragover {
      border-color: var(--primary);
      background: #E6F2F7;
      transform: scale(1.01);
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2><i class="ph ph-image" style="color: var(--primary);"></i> Image Tools</h2>
      </div>
      <nav class="nav-items">
        <a class="nav-item active" data-page="radius">
          <i class="ph ph-corners-in"></i>
          <span>Radius</span>
        </a>
        <a class="nav-item" data-page="autocrop">
          <i class="ph ph-crop"></i>
          <span>Auto Crop</span>
        </a>
      </nav>

      <!-- Theme Selector -->
      <div class="theme-selector">
        <div class="theme-selector-label">Theme</div>
        <div class="theme-options">
          <div class="theme-option theme-pastel active" data-theme="pastel" title="Pastel Dreams"></div>
          <div class="theme-option theme-lavender" data-theme="lavender" title="Lavender Garden"></div>
          <div class="theme-option theme-mint" data-theme="mint" title="Mint Peach"></div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content">
      <!-- Radius Page -->
      <section id="page-radius" class="page-section active">
        <div class="wrap card">
          <h1><i class="ph ph-corners-in" style="color: var(--primary);"></i> Remove Corners — Preview & Download</h1>
          <p class="lead">อัปโหลดรูป (หลายไฟล์ได้) กำหนดค่ามุม (radius) ดูตัวอย่าง แล้วดาวน์โหลดได้ทันที</p>

          <div class="upload-area" id="uploadArea">
            <i class="ph ph-cloud-arrow-up" style="font-size: 48px; margin-bottom: 16px; color: var(--primary);"></i>
            <p style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Click to Upload or Drag & Drop
            </p>
            <p style="margin: 8px 0 0; font-size: 13px; color: var(--muted);">Supports: JPG, PNG, WEBP</p>
          </div>

          <input id="files" type="file" accept="image/*" multiple style="display: none;" />

          <div class="controls">
            <label class="row">
              <span style="margin-right:8px">Radius:</span>
              <input id="radius" type="number" value="90" min="0"
                style="width:80px;padding:6px;border-radius:6px;border:1px solid #e6eef0" />
            </label>
            <button id="previewBtn" class="btn small"><i class="ph ph-eye"></i> Preview</button>
            <button id="downloadAllBtn" class="btn small"><i class="ph ph-download-simple"></i> Download All
              (.zip)</button>
          </div>

          <div id="gallery" class="gallery" aria-live="polite"></div>

          <footer>ไฟล์ที่ได้เป็น PNG โปร่งใส (alpha) — ใช้เบราว์เซอร์ที่รองรับ canvas</footer>
        </div>
      </section>

      <!-- Auto Crop Page -->
      <section id="page-autocrop" class="page-section">
        <div class="wrap card">
          <h1><i class="ph ph-crop" style="color: var(--secondary);"></i> Auto Crop</h1>
          <p class="lead">อัปโหลดรูปเพื่อตัดขอบว่างอัตโนมัติ ระบบจะลบพื้นที่โปร่งใสหรือว่างเปล่ารอบๆ รูปให้อัตโนมัติ</p>

          <div class="upload-area" id="uploadAreaAutoCrop">
            <i class="ph ph-cloud-arrow-up" style="font-size: 48px; margin-bottom: 16px; color: var(--secondary);"></i>
            <p style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Click to Upload or Drag & Drop
            </p>
            <p style="margin: 8px 0 0; font-size: 13px; color: var(--muted);">Supports: JPG, PNG, WEBP</p>
          </div>

          <input id="filesAutoCrop" type="file" accept="image/*" multiple style="display: none;" />

          <div class="controls">
            <button id="previewBtnAutoCrop" class="btn small"><i class="ph ph-eye"></i> Preview</button>
            <button id="downloadAllBtnAutoCrop" class="btn small"><i class="ph ph-download-simple"></i> Download All
              (.zip)</button>
          </div>

          <div id="galleryAutoCrop" class="gallery" aria-live="polite"></div>

          <footer>ไฟล์ที่ได้เป็น PNG โปร่งใส (alpha) — ตัดขอบว่างอัตโนมัติ</footer>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    // ============================================
    // Theme Switching System
    // ============================================

    const themeOptions = document.querySelectorAll('.theme-option');

    // Load saved theme or default to pastel
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'pastel';
      applyTheme(savedTheme);
    }

    // Apply theme to document
    function applyTheme(themeName) {
      // Remove all theme classes
      document.body.removeAttribute('data-theme');

      // Add new theme if not default
      if (themeName !== 'pastel') {
        document.body.setAttribute('data-theme', themeName);
      }

      // Update active state on theme options
      themeOptions.forEach(option => {
        if (option.getAttribute('data-theme') === themeName) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });

      // Save to localStorage
      localStorage.setItem('theme', themeName);
    }

    // Theme option click handlers
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const themeName = option.getAttribute('data-theme');
        applyTheme(themeName);
      });
    });

    // Load theme on page load
    loadTheme();

    // ============================================
    // URL Routing with History API
    // ============================================

    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page-section');

    // Page configuration
    const pageConfig = {
      'radius': {
        title: 'Remove Corners — Preview & Download',
        path: '/radius'
      },
      'autocrop': {
        title: 'Auto Crop — Image Tools',
        path: '/auto_crop'
      }
    };

    // Navigate to a specific page
    function navigateToPage(pageName, shouldPushState = true) {
      const config = pageConfig[pageName];
      if (!config) return;

      // Update URL if needed
      if (shouldPushState) {
        history.pushState({ page: pageName }, config.title, config.path);
      }

      // Update page title
      document.title = config.title;

      // Update active nav item
      navItems.forEach(nav => {
        if (nav.getAttribute('data-page') === pageName) {
          nav.classList.add('active');
        } else {
          nav.classList.remove('active');
        }
      });

      // Show target page
      pages.forEach(page => {
        if (page.id === `page-${pageName}`) {
          page.classList.add('active');
        } else {
          page.classList.remove('active');
        }
      });
    }

    // Get page name from URL path
    function getPageFromPath(path) {
      if (path === '/auto_crop') return 'autocrop';
      if (path === '/radius') return 'radius';
      return 'radius'; // default
    }

    // Handle navigation clicks
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const targetPage = item.getAttribute('data-page');
        navigateToPage(targetPage, true);
      });
    });

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      const pageName = event.state?.page || getPageFromPath(window.location.pathname);
      navigateToPage(pageName, false);
    });

    // Initialize on page load
    const initialPage = getPageFromPath(window.location.pathname);
    navigateToPage(initialPage, false);
    // Set initial state
    history.replaceState({ page: initialPage }, document.title, pageConfig[initialPage].path);

    // ============================================
    // Radius Page Variables and Logic
    // ============================================
    const filesInput = document.getElementById('files');
    const previewBtn = document.getElementById('previewBtn');
    const radiusInput = document.getElementById('radius');
    const gallery = document.getElementById('gallery');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const uploadArea = document.getElementById('uploadArea');

    let files = [];

    // Auto Crop Page Elements
    const filesAutoCropInput = document.getElementById('filesAutoCrop');
    const uploadAreaAutoCrop = document.getElementById('uploadAreaAutoCrop');
    const previewBtnAutoCrop = document.getElementById('previewBtnAutoCrop');
    const downloadAllBtnAutoCrop = document.getElementById('downloadAllBtnAutoCrop');
    const galleryAutoCrop = document.getElementById('galleryAutoCrop');

    let filesAutoCrop = [];

    // Auto Crop - File handling
    filesAutoCropInput.addEventListener('change', e => {
      handleFilesAutoCrop(Array.from(e.target.files));
    });

    uploadAreaAutoCrop.addEventListener('click', () => filesAutoCropInput.click());

    // Auto Crop - Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadAreaAutoCrop.addEventListener(eventName, preventDefaultsAutoCrop, false);
    });

    function preventDefaultsAutoCrop(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadAreaAutoCrop.addEventListener(eventName, () => uploadAreaAutoCrop.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadAreaAutoCrop.addEventListener(eventName, () => uploadAreaAutoCrop.classList.remove('dragover'), false);
    });

    uploadAreaAutoCrop.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const droppedFiles = Array.from(dt.files);
      handleFilesAutoCrop(droppedFiles);
    });

    function handleFilesAutoCrop(newFiles) {
      filesAutoCrop = newFiles;
      if (filesAutoCrop.length > 0) {
        const text = filesAutoCrop.length === 1 ? filesAutoCrop[0].name : `${filesAutoCrop.length} files selected`;
        uploadAreaAutoCrop.querySelector('p').textContent = text;
        const icon = uploadAreaAutoCrop.querySelector('i');
        icon.className = 'ph ph-check-circle';
        icon.style.color = '#4CAF50';
      }
    }

    // Auto Crop Algorithm - Find content bounds
    function getAutoCropBounds(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const width = canvas.width;
      const height = canvas.height;

      let minX = width;
      let minY = height;
      let maxX = 0;
      let maxY = 0;

      // Scan all pixels to find non-transparent boundaries
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const alpha = data[(y * width + x) * 4 + 3];
          if (alpha > 0) { // Non-transparent pixel
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;
          }
        }
      }

      // If no content found, return original dimensions
      if (minX > maxX || minY > maxY) {
        return { x: 0, y: 0, width: width, height: height };
      }

      return {
        x: minX,
        y: minY,
        width: maxX - minX + 1,
        height: maxY - minY + 1
      };
    }

    // Auto Crop - Apply crop to image
    function autoCropCanvas(img) {
      // First, draw image on temp canvas
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = img.width;
      tempCanvas.height = img.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(img, 0, 0);

      // Get crop bounds
      const bounds = getAutoCropBounds(tempCanvas);

      // Create cropped canvas
      const croppedCanvas = document.createElement('canvas');
      croppedCanvas.width = bounds.width;
      croppedCanvas.height = bounds.height;
      const croppedCtx = croppedCanvas.getContext('2d');

      // Draw cropped portion
      croppedCtx.drawImage(
        tempCanvas,
        bounds.x, bounds.y, bounds.width, bounds.height,
        0, 0, bounds.width, bounds.height
      );

      return croppedCanvas;
    }

    async function makeAutoCropForFile(file) {
      const img = await loadImageFromFile(file);
      const canvas = autoCropCanvas(img);
      return new Promise(resolve => canvas.toBlob(blob => resolve({
        blob,
        width: canvas.width,
        height: canvas.height
      }), 'image/png'));
    }

    function clearGalleryAutoCrop() {
      galleryAutoCrop.innerHTML = '';
    }

    // Preview button handler
    previewBtnAutoCrop.addEventListener('click', async () => {
      if (!filesAutoCrop.length) return alert('กรุณาเลือกไฟล์ก่อน');
      clearGalleryAutoCrop();

      for (const f of filesAutoCrop) {
        const holder = document.createElement('div');
        holder.className = 'thumb';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = f.name;
        const imgEl = document.createElement('img');
        imgEl.alt = f.name;
        holder.appendChild(imgEl);
        galleryAutoCrop.appendChild(holder);

        try {
          const { blob, width, height } = await makeAutoCropForFile(f);
          const url = URL.createObjectURL(blob);
          imgEl.src = url;
          const m = document.createElement('div');
          m.className = 'meta';
          m.textContent = `${width}×${height}`;
          holder.appendChild(m);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const dl = document.createElement('button');
          dl.className = 'btn secondary small';
          dl.textContent = 'Download';
          dl.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = f.name.replace(/\.[^.]+$/, '') + '_cropped.png';
            a.click();
          });
          actions.appendChild(dl);
          holder.appendChild(actions);

          // Store blob for zip
          holder._blob = blob;
          holder._name = f.name;
        } catch (err) {
          const e = document.createElement('div');
          e.textContent = 'ไม่สามารถแสดงภาพนี้ได้';
          e.style.color = 'crimson';
          holder.appendChild(e);
        }
      }
    });

    // Download all button handler
    downloadAllBtnAutoCrop.addEventListener('click', async () => {
      if (!galleryAutoCrop.children.length) return alert('ไม่มีภาพที่จะดาวน์โหลด — คลิก Preview ก่อน');
      const zip = new JSZip();
      let added = 0;

      for (const child of Array.from(galleryAutoCrop.children)) {
        const blob = child._blob;
        const name = child._name || ('image' + (added + 1));
        if (blob) {
          zip.file(name.replace(/\.[^.]+$/, '') + '_cropped.png', blob);
          added++;
        }
      }

      if (!added) return alert('ไม่มีไฟล์ถูกเตรียมไว้');
      downloadAllBtnAutoCrop.textContent = 'Preparing...';
      downloadAllBtnAutoCrop.disabled = true;
      const zblob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(zblob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cropped_images.zip';
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        downloadAllBtnAutoCrop.textContent = 'Download All (.zip)';
        downloadAllBtnAutoCrop.disabled = false;
      }, 1500);
    });

    // ============================================
    // Radius Page Logic
    // ============================================

    // Handle file selection via input
    filesInput.addEventListener('change', e => {
      handleFiles(Array.from(e.target.files));
    });

    // Handle click on upload area
    uploadArea.addEventListener('click', () => filesInput.click());

    // Handle drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const droppedFiles = Array.from(dt.files);
      handleFiles(droppedFiles);
    });

    function handleFiles(newFiles) {
      files = newFiles;
      // Optional: Update UI to show selected file count
      if (files.length > 0) {
        const text = files.length === 1 ? files[0].name : `${files.length} files selected`;
        uploadArea.querySelector('p').textContent = text;
        const icon = uploadArea.querySelector('i');
        icon.className = 'ph ph-check-circle';
        icon.style.color = '#4CAF50';
      }
    }

    function loadImageFromFile(file) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => res(img);
          img.onerror = rej;
          img.src = reader.result;
        };
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    function roundedCanvasForImage(img, r) {
      const canvas = document.createElement('canvas');
      const w = img.width, h = img.height;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      const rad = Math.max(0, Math.min(r, Math.min(w, h) / 2));
      ctx.clearRect(0, 0, w, h);
      // rounded rect path
      ctx.beginPath();
      ctx.moveTo(rad, 0);
      ctx.lineTo(w - rad, 0);
      ctx.quadraticCurveTo(w, 0, w, rad);
      ctx.lineTo(w, h - rad);
      ctx.quadraticCurveTo(w, h, w - rad, h);
      ctx.lineTo(rad, h);
      ctx.quadraticCurveTo(0, h, 0, h - rad);
      ctx.lineTo(0, rad);
      ctx.quadraticCurveTo(0, 0, rad, 0);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(img, 0, 0, w, h);
      return canvas;
    }

    async function makePreviewForFile(file, r) {
      const img = await loadImageFromFile(file);
      const canvas = roundedCanvasForImage(img, r);
      return new Promise(resolve => canvas.toBlob(blob => resolve({ blob, width: img.width, height: img.height }), 'image/png'));
    }

    function clearGallery() { gallery.innerHTML = ''; }

    previewBtn.addEventListener('click', async () => {
      if (!files.length) return alert('กรุณาเลือกไฟล์ก่อน');
      clearGallery();
      const r = parseInt(radiusInput.value || 0, 10);
      for (const f of files) {
        const holder = document.createElement('div'); holder.className = 'thumb';
        const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = f.name;
        const imgEl = document.createElement('img'); imgEl.alt = f.name;
        holder.appendChild(imgEl);
        gallery.appendChild(holder);
        try {
          const { blob, width, height } = await makePreviewForFile(f, r);
          const url = URL.createObjectURL(blob);
          imgEl.src = url;
          const m = document.createElement('div'); m.className = 'meta'; m.textContent = `${width}×${height}`;
          holder.appendChild(m);
          const actions = document.createElement('div'); actions.className = 'actions';
          const dl = document.createElement('button'); dl.className = 'btn secondary small'; dl.textContent = 'Download';
          dl.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = url; a.download = f.name.replace(/\.[^.]+$/, '') + '_rounded.png';
            a.click();
          });
          actions.appendChild(dl);
          holder.appendChild(actions);
          // store blob on element for zip
          holder._blob = blob; holder._name = f.name;
        } catch (err) {
          const e = document.createElement('div'); e.textContent = 'ไม่สามารถแสดงภาพนี้ได้'; e.style.color = 'crimson'; holder.appendChild(e);
        }
      }
    });

    downloadAllBtn.addEventListener('click', async () => {
      if (!gallery.children.length) return alert('ไม่มีภาพที่จะดาวน์โหลด — คลิก Preview ก่อน');
      const zip = new JSZip();
      let added = 0;
      for (const child of Array.from(gallery.children)) {
        const blob = child._blob; const name = child._name || ('image' + (added + 1));
        if (blob) { zip.file(name.replace(/\.[^.]+$/, '') + '_rounded.png', blob); added++; }
      }
      if (!added) return alert('ไม่มีไฟล์ถูกเตรียมไว้');
      downloadAllBtn.textContent = 'Preparing...'; downloadAllBtn.disabled = true;
      const zblob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(zblob);
      const a = document.createElement('a'); a.href = url; a.download = 'rounded_images.zip'; a.click();
      setTimeout(() => { URL.revokeObjectURL(url); downloadAllBtn.textContent = 'Download All (.zip)'; downloadAllBtn.disabled = false }, 1500);
    });
  </script>
</body>

</html>
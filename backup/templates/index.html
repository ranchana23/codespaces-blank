<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Image Corners</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans Thai Looped', 'Noto Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fbfbfc; /* soft neutral background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 28px;
            color: #233041;
        }

        .container {
            background: #ffffff; /* clean card */
            border-radius: 12px;
            padding: 28px;
            box-shadow: 0 6px 18px rgba(35, 48, 65, 0.06);
            max-width: 760px;
            width: 100%;
            border: 1px solid #eef3f7;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            color: #64748b;
            text-align: center;
            margin-bottom: 18px;
            font-size: 13px;
            font-weight: 400;
        }
        
        .upload-area {
            border: 2px dashed #e6eef6;
            border-radius: 10px;
            padding: 28px;
            text-align: center;
            background: #ffffff;
            cursor: pointer;
            transition: box-shadow 0.18s ease, transform 0.12s ease;
            margin-bottom: 18px;
        }
        
        .upload-area:hover {
            box-shadow: 0 6px 18px rgba(35, 48, 65, 0.04);
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            box-shadow: 0 8px 22px rgba(35, 48, 65, 0.06);
            border-color: #dbeafc;
        }
        
        .upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .settings {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e6edf3;
            border-radius: 8px;
            font-size: 14px;
            background: #fbfdff;
            transition: box-shadow 0.12s ease, border-color 0.12s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.06);
            border-color: #cfe3ff;
        }
        
        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        button {
            width: 100%;
            padding: 12px 14px;
            background: #cfe8ff; /* pastel blue */
            color: #0f1724;
            border: 1px solid #c6dff8;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.12s, box-shadow 0.12s;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(35, 48, 65, 0.06);
        }
        
        button:disabled {
            background: #f1f5f9;
            color: #9aa6b2;
            border-color: #eef2f6;
            cursor: not-allowed;
        }
        
        .result-preview {
            margin-top: 18px;
            display: none;
            animation: fadeIn 0.28s;
            text-align: center;
        }

        /* Constrain preview image so it doesn't overflow the viewport */
        #resultImg {
            max-width: 100%;
            max-height: 60vh; /* keeps preview within viewport height */
            width: auto;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
            object-fit: contain;
            background: repeating-conic-gradient(#e0e0e0 0% 25%, white 0% 50%) 50% / 20px 20px;
            display: inline-block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-info {
            background: #fbfdff;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 13px;
            color: #536171;
            border: 1px solid #eef6ff;
        }
        
        .result-info strong {
            color: #333;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #fbfbfc;
            border-radius: 8px;
            font-size: 13px;
            color: #55646f;
            border: 1px solid #eef3f7;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Remove Image Corners</h1>
        <p class="subtitle">‡∏•‡∏ö‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô</p>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</strong> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            <p class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, PNG, GIF, BMP, WEBP</p>
        </div>
        
        <input type="file" id="fileInput" accept="image/*" multiple>
        
        <div class="file-info" id="fileInfo" style="display: none;"></div>
        
        <div class="settings">
            <label for="radius">‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á (Radius):</label>
            <input type="text" id="radius" value="10%" placeholder="‡πÄ‡∏ä‡πà‡∏ô: 30 (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•) ‡∏´‡∏£‡∏∑‡∏≠ 12% (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå)">
            <p class="hint">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•) ‡∏´‡∏£‡∏∑‡∏≠ % (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á/‡∏™‡∏π‡∏á)</p>
        </div>
        
        <button id="processBtn" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
        
        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
        
        <div class="result-preview" id="resultPreview">
            <h3>üì∏ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
            <div class="result-info" id="resultInfo"></div>
            <div class="gallery" id="gallery" style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit, minmax(140px,1fr)); gap:12px;"></div>
            <div class="button-group">
                <button id="downloadBtn" class="btn-primary">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button id="newImageBtn" class="btn-secondary">üîÑ ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const processBtn = document.getElementById('processBtn');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const radiusInput = document.getElementById('radius');
        const resultPreview = document.getElementById('resultPreview');
        const resultInfo = document.getElementById('resultInfo');
        const gallery = document.getElementById('gallery');
        const downloadBtn = document.getElementById('downloadBtn');
        const newImageBtn = document.getElementById('newImageBtn');
        
        let selectedFiles = [];
        let processedPreviews = [];

        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        function handleFiles(files) {
            const arr = Array.from(files).filter(f => f.type && f.type.startsWith('image/'));
            if (arr.length === 0) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            selectedFiles = arr;

            // Show file info (count + names)
            const names = selectedFiles.map(f => f.name).join(', ');
            const totalKB = (selectedFiles.reduce((s, f) => s + f.size, 0) / 1024).toFixed(2);
            fileInfo.textContent = `‡πÑ‡∏ü‡∏•‡πå: ${selectedFiles.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî ${names} (${totalKB} KB)`;
            fileInfo.style.display = 'block';

            // Enable preview button
            processBtn.disabled = false;
            processBtn.textContent = `Preview (${selectedFiles.length})`;

            hideError();
            hideSuccess();
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFiles || selectedFiles.length === 0) return;

            const formData = new FormData();
            selectedFiles.forEach(f => formData.append('file', f));
            formData.append('radius', radiusInput.value || '10%');

            loading.style.display = 'block';
            processBtn.disabled = true;
            hideError();
            hideSuccess();
            resultPreview.style.display = 'none';

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                const result = await response.json();

                // Store processed previews
                processedPreviews = result.previews || [];

                // populate gallery
                gallery.innerHTML = '';
                processedPreviews.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'thumb';
                    div.style.textAlign = 'center';
                    div.style.padding = '6px';
                    div.style.background = '#fafafa';
                    div.style.borderRadius = '8px';
                    div.innerHTML = `\
                        <img src="${item.preview}" style="max-width:100%; max-height:140px; border-radius:8px; display:block; margin:0 auto;">\
                        <div style="font-size:12px; color:#444; margin-top:6px">${item.filename}</div>\
                        <button class="thumb-download" data-idx="${idx}" style="margin-top:8px; padding:6px 8px; font-size:13px;">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>`;
                    gallery.appendChild(div);
                });

                // add click handlers for per-thumb download
                gallery.querySelectorAll('.thumb-download').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const idx = Number(btn.getAttribute('data-idx'));
                        const item = processedPreviews[idx];
                        if (!item) return;
                        try {
                            const r = await fetch('/download', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ images: [item] })
                            });
                            if (!r.ok) throw new Error('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                            const blob = await r.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = item.filename || 'image_rounded.png';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            showSuccess(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${item.filename} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`);
                        } catch (err) {
                            showError(err.message || '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                        }
                    });
                });

                resultInfo.innerHTML = `<strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${processedPreviews.length} ‡∏†‡∏≤‡∏û`;
                resultPreview.style.display = 'block';
                showSuccess('‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚Äî ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á');

            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
                processBtn.disabled = false;
            }
        });

        downloadBtn.addEventListener('click', async () => {
            if (!processedPreviews || processedPreviews.length === 0) return;

            try {
                // Request server to build a single ZIP and return it
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ images: processedPreviews })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'images_rounded.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccess('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ZIP ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');

            } catch (error) {
                showError(error.message);
            }
        });

        newImageBtn.addEventListener('click', () => {
            selectedFiles = [];
            processedPreviews = [];
            fileInput.value = '';
            fileInfo.style.display = 'none';
            resultPreview.style.display = 'none';
            gallery.innerHTML = '';
            processBtn.disabled = true;
            processBtn.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô';
            hideError();
            hideSuccess();
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function showSuccess(message) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function hideSuccess() {
            successDiv.style.display = 'none';
        }
    </script>
</body>
</html>
